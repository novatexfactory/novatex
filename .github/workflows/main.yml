name: Build, Push and Deploy

on:
  push:
    branches: [ "main" ]

env:
  DOCKER_IMAGE_NAME: ${{ secrets.DOCKER_USERNAME }}/novatex-backend

jobs:
  # === –ß–ê–°–¢–¨ 1: –°–±–æ—Ä–∫–∞ ===
  build:
    runs-on: ubuntu-latest
    steps:
    - name: üì• Checkout code
      uses: actions/checkout@v3

    - name: üê≥ Login to Docker Hub
      uses: docker/login-action@v2
      with:
        username: ${{ secrets.DOCKER_USERNAME }}
        password: ${{ secrets.DOCKER_PASSWORD }}

    - name: üèóÔ∏è Build and Push Docker Image
      uses: docker/build-push-action@v4
      with:
        context: .
        file: ./Dockerfile
        push: true
        tags: ${{ env.DOCKER_IMAGE_NAME }}:latest

  # === –ß–ê–°–¢–¨ 2: –î–µ–ø–ª–æ–π ===
  deploy:
    runs-on: ubuntu-latest
    needs: build
    steps:
    - name: üöÄ Deploy to Server via SSH
      uses: appleboy/ssh-action@master
      with:
        host: ${{ secrets.SERVER_IP }}
        username: ${{ secrets.SERVER_USER }}
        key: ${{ secrets.SSH_PRIVATE_KEY }}
        script: |
          # 1. –ó–∞—Ö–æ–¥–∏–º –≤ –ø–∞–ø–∫—É –ø—Ä–æ–µ–∫—Ç–∞ (–∫–æ—Ç–æ—Ä–∞—è –±—ã–ª–∞ –∫–ª–æ–Ω–∏—Ä–æ–≤–∞–Ω–∞ —á–µ—Ä–µ–∑ git clone)
          cd ~/novatex-prod
          
          # 2. –°–∫–∞—á–∏–≤–∞–µ–º —Å–≤–µ–∂–∏–π docker-compose.yml –∏ –∏–∑–º–µ–Ω–µ–Ω–∏—è –∫–æ–¥–∞
          git pull origin main
          
          # 3. –°–∫–∞—á–∏–≤–∞–µ–º —Ç–æ–ª—å–∫–æ —á—Ç–æ —Å–æ–±—Ä–∞–Ω–Ω—ã–µ Docker-–æ–±—Ä–∞–∑—ã
          docker compose pull
          
          # 4. –ü–µ—Ä–µ–∑–∞–ø—É—Å–∫–∞–µ–º –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä—ã (—É–¥–∞–ª—è—è —Å—Ç–∞—Ä—ã–µ/–ª–∏—à–Ω–∏–µ, –µ—Å–ª–∏ –µ—Å—Ç—å)
          docker compose up -d --remove-orphans
          
          # 5. –ß–∏—Å—Ç–∏–º –º–µ—Å—Ç–æ –Ω–∞ –¥–∏—Å–∫–µ –æ—Ç —Å—Ç–∞—Ä—ã—Ö –æ–±—Ä–∞–∑–æ–≤
          docker image prune -f