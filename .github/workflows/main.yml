name: Build, Push and Deploy

on:
  push:
    branches: [ "main" ]

env:
  DOCKER_IMAGE_NAME: ${{ secrets.DOCKER_USERNAME }}/novatex-backend

jobs:
  # –ü–µ—Ä–≤–∞—è —á–∞—Å—Ç—å: –°–±–æ—Ä–∫–∞ –∏ –æ—Ç–ø—Ä–∞–≤–∫–∞ –æ–±—Ä–∞–∑–∞ –Ω–∞ Docker Hub
  build:
    runs-on: ubuntu-latest
    steps:
    - name: üì• Checkout code
      uses: actions/checkout@v3

    - name: üê≥ Login to Docker Hub
      uses: docker/login-action@v2
      with:
        username: ${{ secrets.DOCKER_USERNAME }}
        password: ${{ secrets.DOCKER_PASSWORD }}

    - name: üèóÔ∏è Build and Push Docker Image
      uses: docker/build-push-action@v4
      with:
        context: .
        push: true
        tags: ${{ env.DOCKER_IMAGE_NAME }}:latest

  # –í—Ç–æ—Ä–∞—è —á–∞—Å—Ç—å: –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π –¥–µ–ø–ª–æ–π –Ω–∞ –≤–∞—à AWS
  deploy:
    runs-on: ubuntu-latest
    needs: build  # <--- –≠—Ç–æ —Ç—Ä–∏–≥–≥–µ—Ä: –¥–µ–ø–ª–æ–π –Ω–∞—á–Ω–µ—Ç—Å—è —Ç–æ–ª—å–∫–æ –ø–æ—Å–ª–µ –ø—É—à–∞ –æ–±—Ä–∞–∑–∞
    steps:
    - name: üöÄ Deploy to Server via SSH
      uses: appleboy/ssh-action@master
      with:
        host: ${{ secrets.SERVER_IP }}
        username: ${{ secrets.SERVER_USER }}
        key: ${{ secrets.SSH_PRIVATE_KEY }}
        script: |
          cd ~/novatex-prod
          docker compose pull  # –°–∫–∞—á–∏–≤–∞–µ–º —Å–≤–µ–∂–∏–π –æ–±—Ä–∞–∑ —Å Docker Hub
          docker compose up -d  # –ü–µ—Ä–µ–∑–∞–ø—É—Å–∫–∞–µ–º –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä—ã –Ω–∞ 80 –ø–æ—Ä—Ç—É
          docker image prune -f  # –£–¥–∞–ª—è–µ–º —Å—Ç–∞—Ä—ã–µ –Ω–µ–Ω—É–∂–Ω—ã–µ –æ–±—Ä–∞–∑—ã, —á—Ç–æ–±—ã –Ω–µ –∑–∞–±–∏–≤–∞—Ç—å AWS